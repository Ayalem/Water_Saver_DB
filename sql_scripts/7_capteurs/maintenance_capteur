CREATE OR REPLACE PROCEDURE maintenance_capteur(
    p_capteur_id NUMBER,
    p_technicien_id NUMBER,
    p_description VARCHAR2,
    p_duree_minutes NUMBER
) IS
    v_parcelle_id NUMBER;
    v_intervention_id NUMBER;
BEGIN
    SELECT parcelle_id INTO v_parcelle_id
    FROM CAPTEUR
    WHERE capteur_id = p_capteur_id;
    UPDATE CAPTEUR
    SET statut = 'MAINTENANCE',
        date_derniere_maintenance = SYSDATE
    WHERE capteur_id = p_capteur_id;
    INSERT INTO INTERVENTION (
        parcelle_id, capteur_id, technicien_id,
        type_intervention, priorite, statut,
        description, date_debut, duree_minutes
    ) VALUES (
        v_parcelle_id, p_capteur_id, p_technicien_id,
        'MAINTENANCE_CAPTEUR', 'MOYENNE', 'EN_COURS',
        p_description, SYSDATE, p_duree_minutes
    ) RETURNING intervention_id INTO v_intervention_id;
    INSERT INTO NOTIFICATION (user_id, intervention_id, type_notification, message)
    VALUES (p_technicien_id, v_intervention_id, 'INTERVENTION_ASSIGNEE',
            'Maintenance capteur ' || p_capteur_id || ' assign√©e');
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END maintenance_capteur;
/
